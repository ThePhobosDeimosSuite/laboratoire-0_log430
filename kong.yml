_format_version: "3.0"
_transform: true

services:
  - name: product-service
    host: product-service
    routes:
      - name: product-route
        paths:
          - /api/product
        strip_path: false

  - name: sales-service
    url: http://sales-service:3000
    routes:
      - name: sales-route
        paths:
          - ~/api/store/[0-9]+/sales.*$
        strip_path: false

  - name: stocks-service
    url: http://stocks-service:3000
    routes:
      - name: stocks-route
        paths:
          - ~/api/store/[0-9]+/stock.*$
          - ~/api/store/[0-9]+/order.*$
        strip_path: false

upstreams:
  - name: product-service
    algorithm: round-robin
    targets:
      - target: product-service:3000
        weight: 100
      - target: product-service2:3000
        weight: 100

plugins:
  - name: prometheus          
    enabled: true
    protocols: [http, https]
    config:
      latency_metrics:     true   # latency
      status_code_metrics: true   # traffic & errors
      bandwidth_metrics:   true   #  saturation
      upstream_health_metrics: true  # keeps upstream health gauges